## - (1) checks to see if account is active:
##   - if logged in: display thanks (short) and goto target
##   - if not logged-in: go to log-in with message: "account active, now log-in"
## - if not active
##   - go to activation request EmailSentValidationLink.vm
##   - go to activation request
## - checks to see if there's an opener that's a login-dialog, opens itself there then
#* @vtlvariable name="doc" type="com.xpn.xwiki.api.Document" *#
## @vtlvariable name="asset" type="org.curriki.xwiki.plugin.asset.Asset"
## @vtlvariable name="document" type="com.xpn.xwiki.api.Document"
#* @vtlvariable name="xwiki" type="com.xpn.xwiki.api.XWiki" *# ##
#* @vtlvariable name="util" type="com.xpn.xwiki.api.Util" *# ##
#* @vtlvariable name="request" type="javax.servlet.http.HttpServletRequest" *# ##
#* @vtlvariable name="context" type="com.xpn.xwiki.api.Context" *# ##
#* @vtlvariable name="msg" type="com.xpn.xwiki.web.XWikiMessageTool" *# ##
#* @vtlvariable name="escapetool" type="org.apache.velocity.tools.generic.EscapeTool" *# ##
<!-- THIS IS BackFromGCheckout -->
#if($targets)#else#set($targets=$xwiki.parseGroovyFromPage("Registration.TargetsGroovy"))##
#set($junk=$targets.init($request,$xwiki))#end<!-- targets is $targets  -->#if($targets=="groovy_missingrights")#warn("warning, missing rights, expect malfunction.")#end ##
{pre}#if($redir)#else#set($redir=$request.redir)#end##
#set($username=$request.user)
#if($username)#else#set($username=$context.user)#end
#if($username.startsWith("XWiki."))#else#set($username="XWiki.$username")#end
#if($username!="XWiki.XWikiGuest")
    #set($userdoc=$xwiki.getDocument($username))
    #if($userdoc)<!-- userdoc is $userdoc of class $userdoc.getClass() with objects $userdoc.getObject("XWiki.XWikiRights") -->
        #set($userobj=$userdoc.getObject("XWiki.XWikiUsers"))
        <!-- userobj is $userobj active? $userobj.getProperty('active').value -->
        #if("$userobj.getProperty('active').value"=="1")
            #if($context.user!="XWiki.XWikiGuest")
                #set($redir=$targets.afterLogin)
            #else
                $request.session.setAttribute("messagesForNextLoginRequest",$msg.get("Your account is active, please log-in."))
                #set($redir="/xwiki/bin/view/Registration/LoginOrRegister?xpage=popup&framed=true")
            #end
        #else
            #set($redir="/xwiki/bin/view/Registration/EmailSentValidationLink?xpage=popup")
            ## #set($redir="/xwiki/bin/view/Sandbox/Try")
        #end
    #end
#end
#if(!$included && $request.xpage=="plain")
<html><head><title>Redirection</title>
    #template("javascripts.vm")
    #template("stylesheets.vm")
</head><body>##
#elseif($request.xpage=="popup")
    #set($globalDebug=true)##
    #template("javascripts.vm")
#end
#if($redir.startsWith("%2"))#set($redir=$redir.replaceAll("%2F","/"))#end
<p style="width:100%; height:100%; text-align: center; line-height:2em; background-color: white;"
        ><a style="text-decoration: none; color: #4E83C7; font-size: 12px; font-family: arial, helvetica, sans-serif; line-height:10em"##
   id="followMeLink" href="${redir}" target="_top">$msg.get("registration.jump.proceeding")</a><br/>
<button type="button-grey" onclick="if(window.top.location.href.indexOf('/xwiki/bin/view/Registration')>0) {window.top.back();} else {window.top.reload();}">$msg.get("join.login.cancel_button")</button>
</p>##
<script type="text/javascript">##
  #if($redir.startsWith("/xwiki/bin/view/Registration"))
    Curriki.ui.login.finishAuthorizationPopup("${redir}", window.opener, window, false);
    ##alert("Would do: Curriki.ui.login.finishAuthorizationPopup('${redir}', window.opener, window,false);")
  #else
    Curriki.ui.login.finishAuthorizationPopup("${redir}", window.opener, window, true);
    ##alert("Would do: Curriki.ui.login.finishAuthorizationPopup('${redir}', window.opener, window,true);")
  #end##
</script>
#if(!$included && $request.xpage=="plain")
</body></html>##
#end
{/pre}