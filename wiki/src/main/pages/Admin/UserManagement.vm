#* @vtlvariable name="xwiki" type="com.xpn.xwiki.api.XWiki" *# ##
#* @vtlvariable name="context" type="com.xpn.xwiki.api.Context" *# ##

#set($userManagement=$xwiki.parseGroovyFromPage("Admin.UserManagementGroovy"))
$userManagement.init($request, $xwiki, $context)
$userManagement.processReceivedData()
#set($foundUsers = $userManagement.getFoundUsers())

{pre}<script type="text/javascript">
    Ext.onReady(function(){
        sortParam = gup("sort");
        setSortColumn(sortParam);
    });
    function gup( name )
    {
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( window.location.href );
        if( results == null )
            return "";
        else
            return results[1];
    }
    function removeAllOtherSortColumnStyles(){
        var columnHeaderIds = new Array("userNameHeader", "userFirstNameHeader", "userLastNameHeader", "userEmailHeader");
        for(headerId in columnHeaderIds){
            var headerElement = Ext.get(headerId);
            if(headerElement != null){
                headerElement.removeClass("sortColumn")
            }
        }
    }
    function setSortColumn(columnName){
        removeAllOtherSortColumnStyles();
        var targetId = "";
        if (columnName.indexOf("userName") != -1) {
            targetId = "userNameHeader"
        } else if (columnName.indexOf("userFirstName") != -1) {
            targetId = "userFirstNameHeader"
        } else if (columnName.indexOf("userLastName") != -1) {
            targetId = "userLastNameHeader"
        } else if (columnName.indexOf("userEmail") != -1) {
            targetId = "userEmailHeader"
        } else {
            targetId == "userNameHeader"
        }
        var targetHeaderElement = Ext.get(targetId);
        if(targetHeaderElement != null){
            targetHeaderElement.addClass('sortColumn')
        }
    }
    function changeSortColumn(columnName){
        var sortParamGetFormElement = Ext.get("sortParamGetForm");
        var sortParamPostFormElement = Ext.get("sortParamPostForm");

        //Lookup which order is choosen
        var sortParam = gup("sort");
        var order = "asc"

        if(sortParam.indexOf(columnName)!=-1){  // If the same field is clicked twice the paramter already contains the field name
            if(sortParam.indexOf("asc")!=-1){  // Then we want to switch the order of the results.
                order = "desc";
            }else if(sortParam.indexOf("desc")!=-1){
                order = "asc";
            }
        }

        if(sortParamGetFormElement != null){
            sortParamGetFormElement.set({value: columnName+" "+order})
        }

        if(sortParamPostFormElement != null){
            sortParamPostFormElement.set({value: columnName+""+order})
        }
        Ext.get("searchForm").dom.submit();

    }
    function showHide(div){
        if(document.getElementById(div).style.display == 'none'){
            document.getElementById(div).style.display = 'block';
        }else{
            document.getElementById(div).style.display = 'none';
        }
    }
    function warnIfUsersShouldBeDeleted(){
        var inputs = document.getElementsByTagName("input");
        for(i = 0; i < inputs.length; i++){
           var input = inputs[i];
           var value = input.getAttribute("value");
           if(input.getAttribute("value") == "TO_DELETE" && input.checked){
            return confirm("You marked one or more user/s for deletion. You know what you are doing?");
           }
        }
        return true;
    }
    function increaseCurrentPageNumber(max){
        var currentNumber = parseInt(document.getElementById("pageNumberGetForm").getAttribute("value"));
        if(parseInt(max)>=(currentNumber+1)){
            document.getElementById("pageNumberGetForm").setAttribute("value", currentNumber+1);
            document.getElementById("pageNumberPostForm").setAttribute("value", currentNumber+1);
            document.getElementById("searchForm").submit();
        }
    }
    function decreaseCurrentPageNumber(){
        var currentNumber = parseInt(document.getElementById("pageNumberGetForm").getAttribute("value"));
        if(currentNumber - 1 >= 1){
            document.getElementById("pageNumberPostForm").setAttribute("value", currentNumber-1);
            document.getElementById("pageNumberGetForm").setAttribute("value", currentNumber-1);
            document.getElementById("searchForm").submit();
        }
    }
</script>
{/pre}


<style>
    tr th {
        background-color: transparent;
        border-bottom: solid 1px grey;
    }
    th {
        padding-left: 0.5em;
        vertical-align: bottom;
        height: 8.5em;
    }
    td {
        padding-left: 0.5em;
        padding-top: 1em;
    }
    .vertical_text {
        border:0px;
        writing-mode:tb-rl;
        -webkit-transform:rotate(90deg);
        -moz-transform:rotate(90deg);
        -o-transform: rotate(90deg);
        white-space:nowrap;
        width:2em;
        background-color: transparent;
        vertical-align: middle;
    }
    #usernames {
        width: 50%;
        height: 10em;
        float: left;
        #if( ! $foundUsers)
            background-color: #ffbfbf;
            border: 1px solid #ff8080;
        #end
    }
    .clearfix {
        clear: both;
    }
    #wrongInputNotification {
        height: 12em;
        color: #ff4040;
    }
    #wrongInputNotificationBorder {
        position: relative;
        padding: 0.5em;
        margin-left: 0.5em;
        top: 0.6em;
        left: 5%;
    }
    .resultHeading {
        position: relative;
        left: 1.5em;
    }
    .resultText {
        position: relative;
        padding-left: 2.5em;
    }
    #successMessage {
        color: #00c200;
        position: relative;
        left: 1.5em;
    }
    .warningMessage {
        color: rgba(245, 156, 39, 0.97);
        position: relative;
        left: 1.5em;
    }
    .errorMessage {
        color: #ff4040;
        position: relative;
        left: 1.5em;
    }
    .sortColumn{
        color: #4d82f3;
        text-decoration:underline;
    }
    .tableHeaderHover:hover {
        color: #413cf3;
        text-decoration:underline;
    }
</style>

<h2>User-Management-Tool</h2>
<p>

<h3>Activate - Deactivate - Inactivate</h3>
<ol>
    <li>Search for one or more users by name</li>
    <li>Apply changes to the states of the found users</li>
    <li>Hit "Set changed status" button</li>
</ol>
</p>
<p>
<h3>Delete</h3>
<ol>
    <li>Search one or more users by name</li>
    <li>Set the state of the user you want to delete</li>
</ol>
</p>
<form id="searchForm" method="GET">
    <input type="hidden" name="searchUsers"  value="true"/>
    <input id="pageNumberGetForm" type="hidden" name="pageNumber" #if($request.pageNumber) value="${request.pageNumber}" #else value="1" #end />
    <p><label for="usernames">$msg.get('join.login.username') (e.g. jmkars plox tsherman)</label></p>
    <textarea id="usernames" name="usernames" onkeydown="if (event.keyCode == 13) { this.form.submit(); return false; }">#if($request.usernames)${request.usernames}#end</textarea>
    #if( ! $foundUsers )
        <div id="wrongInputNotification">
            <div id="wrongInputNotificationBorder">
                Sorry your input was not well formed.<br>
                Please be sure to:
                <ul>
                    <li>Don't use commas to separate search terms</li>
                    <li>Have all parenthesis closed correct</li>
                    <li>Have all parenthesis closed correct</li>
                </ul>
            </div>
        </div>
    #end
    <div class="clearfix"></div>
    <label for="rows">Results per page:</label>
    <select id="rows" name="rows">
        <option #if($request.rows=="25")selected#end>25</option>
        <option #if($request.rows=="50")selected#end>50</option>
        <option #if($request.rows=="100")selected#end>100</option>
    </select>
    <br>
    <input type="submit" class="button" value="Search"/>
    <input id="sortParamGetForm" type="hidden" name="sort" #if($request.sort) value="${request.sort}" #else value="userName asc" #end />
</form>


#if($foundUsers && $request.applyStatusChanges != "true" && $request.searchUsers)

<h4>Found $userManagement.getTotalNumberOfSolrResults() results </h4>
<form method="POST" style="position: relative; top:-3em;" onsubmit="return warnIfUsersShouldBeDeleted()">
    <input type="hidden" name="applyStatusChanges" value="true"/>
    <table style=" table-layout: fixed; width: 100%; padding: 25px; word-wrap: break-word;">
        <tr>
            <th id="userNameHeader" class="tableHeaderHover" onclick="changeSortColumn('userName')" style="width: 15%"><div class="vertical_hidden_text"></div>Accountname<img src="/xwiki/skins/curriki8/images/adv-search-sort-sprite.gif"></th>
            <th id="userEmailHeader" class="tableHeaderHover" onclick="changeSortColumn('userEmail')" style="width: 25%"><div class="vertical_hidden_text"></div>Email</th>
            <th id="userFirstNameHeader" class="tableHeaderHover" onclick="changeSortColumn('userFirstName')" ><div class="vertical_hidden_text"></div>Firstname</th>
            <th id="userLastNameHeader" class="tableHeaderHover" onclick="changeSortColumn('userLastName')" ><div class="vertical_hidden_text"></div>Lastname</th>
            <th class="vertical_text">Active</th>
            <th class="vertical_text">Inactive</th>
            <th class="vertical_text">Deactivated</th>
            <th class="vertical_text">Delete</th>
        </tr>

        #foreach($user in $foundUsers) ##Create a row for each found user
            <tr>
                <td>
                    <a href="/xwiki/bin/view/XWiki/${user.userName}"">$user.userName (<a href="/xwiki/bin/edit/XWiki/$user.userName?editor=object">edit</a>)</a>
                </td>
                <td>
                    #if($user.userEmail)
                        $user.userEmail
                    #else
                        <p style="color: red;">No Email</p>
                    #end
                </td>
                <td>$user.userFirstName</td>
                <td>$user.userLastName</td>

                <td>
                    <input type="radio" name="${user.userName}.STATE"value="ACTIVE" #if($user.userActive == "true" && $user.userEmailUndeliverable == "false") checked  #end/>
                </td>

                <td style="padding-left: 0.5em; padding-top: 1em;">
                    <input type="radio" name="${user.userName}.STATE" value="INACTIVE" #if($user.userActive == "false" && $!user.userEmailUndeliverable == "true") checked  #end/>
                </td>

                <td style="padding-left: 0.5em; padding-top: 1em;">
                    <input type="radio" name="${user.userName}.STATE" value="DEACTIVATED" #if($user.userActive == "false" && $!user.userEmailUndeliverable == "false") checked  #end/>
                </td>

                <td style="padding-left: 0.5em; padding-top: 1em;">
                    <input type="radio" name="${user.userName}.STATE" value="TO_DELETE" />
                </td>
            </tr>
        #end

    </table>
    <input type="submit" class="button" value="Apply status changes" #if($foundUsers.size()==0)disabled="disabled"#end/>
    <input id="pageNumberPostForm" type="hidden" name="pageNumber" #if($request.pageNumber) value="${request.pageNumber}" #else value="1" #end />
    <input type="hidden" name="usernames" #if($request.usernames)value="${request.usernames}"#else value="" #end />
    <input type="hidden" name="rows" #if($request.rows)value="${request.rows}"#else value="" #end />
    <input id="sortParamPostForm" type="hidden" name="sort" #if($request.sort) value="${request.sort}" #else value="userName asc" #end />
</form>

    #set($totalNumberOfPages=$userManagement.getTotalNumberOfPages())
<div style="float:right; padding: 0.5em;" onclick="increaseCurrentPageNumber('$totalNumberOfPages');"><a href="#" > Next &gt;&gt;</a></div>
<div style="float:right; padding: 0.5em;"> Page: $request.pageNumber of $totalNumberOfPages </div>
<div style="float:right; padding: 0.5em;" onclick="decreaseCurrentPageNumber();"><a href="#" > &lt;&lt; Previous </a> </div>
#end



#if($request.applyStatusChanges == "true")
    #set($activatedUsers=$userManagement.getActivatedUsers())
    #set($inactivatedUsers=$userManagement.getInactivatedUsers())
    #set($deactivatedUsers=$userManagement.getDeactivatedUsers())
    #set($deletedUsers=$userManagement.getDeletedUsers())
    #set($warnings=$userManagement.getWarnings())
    #set($errors=$userManagement.getErrors())

    <h2>Results of status changes</h2>
    <br>

    #if($warnings.size() == 0 && $errors.size() == 0)
    <div  id="successMessage">
        <h3>OK</h3>
        <ul>
            <li>Users changed</li>
            <li>Reindex triggered</li>
            <li>It takes a moment until your changes appear to search</li>
        </ul>
    </div>
    #end
    #if($warnings.size() > 0)
    <div  class="warningMessage">
        <h3>Warning</h3>
        <ul>
            <li>There had been problems deleting some users</li>
            <li>See messages below for further</li>
            <li>It takes a moment until your changes appear to search</li>
        </ul>
        <br>
        #foreach($warningsForUser in $warnings)
            #set($userName=$warningsForUser.get("userName"))
            #set($cause=$warningsForUser.get("cause"))

            #if($cause == "WARNING_USER_STILL_HAS_CONTRIBUTIONS")
            The user $userName could not be deleted, he/she still has <a href="#" onclick="showHide('${userName}.stillHasContributions');">$warningsForUser.get("numberOfContributions") contribution/s </a> in Curriki. <br>
                <div id="${userName}.stillHasContributions" style="display: none;">
                    <ul class="resourceList">
                    #foreach($resource in $warningsForUser.get("userResources"))
                        <li><a href="/xwiki/bin/view/${resource.replace(".","/")}">$resource</a></li>
                    #end
                    </ul>
                </div>
            #end

            #if($cause == "WARNING_USER_IS_SYSTEM_ADMIN")
            The user $userName could not be deleted, he/she is a system admin. <br>
            #end

            #if($cause == "WARNING_USER_IS_GROUP_ADMIN")
            The user $userName could not be deleted, he/she is a group admin in <a href="#" onclick="showHide('${userName}.isGroupAdmin');">$warningsForUser.get("groupNames").size() groups</a>. <br>
             <div id="${userName}.isGroupAdmin" style="display: none;">
                <ul class="resourceList">
                    #foreach($groupName in $warningsForUser.get("groupNames"))
                        <li><a href="/xwiki/bin/view/${groupName}/WebHome">$groupName</a></li>
                    #end
                </ul>
            </div>
            #end

            #if($cause == "WARNING_USER_IS_YOURSELF")
            The user $userName could not be deleted, you cannot delete yourself. <br>
            #end

        #end
    </div>
    #end

    #if($errors.size() > 0 )
    <div  class="errorMessage">
        <h3>Error</h3>
        <ul>
            <li>There had been errors while deleting a user</li>
            <li>See messages below for further information</li>
            <li>It takes a moment until your changes appear to search</li>
        </ul>
        <br>
        #foreach($error in $errors)
            $error <br>
        #end
    </div>
    #end
    <br>
    <hr>

    <h3 class="resultHeading">$activatedUsers.size() activated</h3>
    <p class="resultText">
        #foreach($user in $activatedUsers)
                $user
        #end
    </p>
    <hr>

    <h3 class="resultHeading"> $inactivatedUsers.size() inactivated</h3>
    <p class="resultText">
        #foreach($user in $inactivatedUsers)
                $user
        #end
    </p>
    <hr>

    <h3 class="resultHeading">$deactivatedUsers.size() deactivated</h3>
    <p class="resultText">
        #foreach($user in $deactivatedUsers)
                $user
        #end
    </p>
    <hr>

    <h3 class="resultHeading">$deletedUsers.size() deleted</h3>
    <p class="resultText">
        #foreach($user in $deletedUsers)
                $user
        #end
    </p>
#end

