##
## This page is included by other pages when a delivery on top
## of the useful windows is needed instead of a framed or popped-up one.
##
## it needs one variable or parameter to be defined: redir
{pre}#if($redir)#else#set($redir=$request.redir)#end##
#if($targets)#else#set($targets=$xwiki.parseGroovyFromPage("Registration.TargetsGroovy"))##
#set($junk=$targets.init($request,$xwiki))#end##
#if($redir)#else#set($redir=$targets.afterLogin)#end##
#if($redir)#else#set($redir="/")#end##
#if($redir.contains("Registration/JumpToTop"))#set($redir="/")#end
#set($hasDownload=$redir.matches(".*force(..?.?)?download=1.*"))##
#set($directURL=$redir)##
#if($hasDownload)#set($directURL=$targets.fromDownloadToResource($redir))#end ##
<html><head><title>Redirection</title></head><body>##
#if($request.getHeader("User-Agent").contains(" Chrome"))
    #set($redir="http://$hostname$redir")##
    $xwiki.includeForm("Registration.LoginSuccessful",false)##
#else
<p style="width:100%; height:100%; text-align: center; line-height:10em; background-color: white;"
        ><a id="followMeLink" href="${redir}" target="_top">$msg.get("registration.jump.proceeding")</a>##
    ##<img src="/xwiki/skins/curriki8/icons/spinner.gif"/>
        </p>##

<script type="text/javascript">
    var w = window;
    try {
        if (w.name == 'curriki-identity-dialog-popup'
                && w.opener && w.opener.name == 'curriki-identity-dialog') {
            w = window.opener;
            if (!(w.name)) w.name = "curriki-parent-window";
            window.links[0].target = w.name;
        }
    } catch(e) {
        if(console) console.log("Can't check for parent.",e);
    }
    w.moveOnTask = null;
    function moveOn() {
        window.clearInterval(w.moveOnTask);
        var targ = "${redir}";
        w.moveOnTask = null;
        if("undefined"!==typeof(console)) {console.log("Jumping to targ");}
        var hasDownload = $hasDownload;
        if(hasDownload && window.top!=window) {
            if("undefined"!==typeof(console)) {console.log("Also reload page.");}
            window.moveOnTask =
                    window.setInterval(
                            "window.clearInterval(window.moveOnTask); window.top.location.reload();",500);
        } else {
            w.top.location.replace(targ);
        }
    }
    w.moveOnTask = window.setInterval(moveOn,50);</script>
#if($hasDownload)
        <iframe width="200" height="100" src="$redir">
            <p><a href="$redir">downloading</a>.</p>
        </iframe>
#end
</body></html>##
#end
{/pre}