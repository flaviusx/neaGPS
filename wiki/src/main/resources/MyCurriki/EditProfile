<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
<web>MyCurriki</web>
<name>EditProfile</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent>MyCurriki.Profile</parent>
<creator>XWiki.ShermanTank</creator>
<author>XWiki.ShermanTank</author>
<customClass></customClass>
<contentAuthor>XWiki.ShermanTank</contentAuthor>
<creationDate>1202337402000</creationDate>
<date>1202338924000</date>
<contentUpdateDate>1202338924000</contentUpdateDate>
<version>1.1</version>
<title>Edit Profile</title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Deleted page by accident. Replacing it from Production.</comment>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>MyCurriki.EditProfile</name>
<number>0</number>
<className>XWiki.TagClass</className>
<property>
<tags/>
</property>
</object>
<content>#includeMacros("MyCurriki.MyCurrikiMacros")
## content macro
#macro(mycurrikipage_content $userdoc $userobj)
#if($context.user == $userdoc.fullName)
#set($userarg = "")
#else ## user == owner
#set($userarg = "user=${userdoc.fullName}")
#if(!$xwiki.hasAdminRights())
$response.sendRedirect($xwiki.getURL('MyCurriki.Profile', "$userarg"))
#end ## not admin
#end ## user == owner
#set($xredirect = $xwiki.getURL("MyCurriki.Profile", "view", "$userarg"))
## #set($xeditredirect = $xwiki.getURL("MyCurriki.EditProfile", "view", "user=${userdoc.fullName}"))
#set($xeditredirect = $xwiki.requestURL)
#mycurrikititlebar($msg.get("mycurriki.editprofile.titlebar") "" "" "blue")
&lt;form id="inline" action="$userdoc.getURL("preview")" method="post"&gt;
&lt;br /&gt;
&lt;table border="0" cellspacing="0" cellpadding="3"&gt;
 &lt;tr&gt;
  &lt;td valign="top"&gt;
   &lt;div class="userpic"&gt;
   #set($width = 88)
#if($userdoc.attachmentList.size()==0) 
   &lt;img src="$xwiki.getSkinFile("noavatar.png")" width="${width}"/&gt;
#else
   #foreach ($attach in $userdoc.attachmentList)
     &lt;a class="curriki-link" href="$userdoc.getAttachmentURL($attach.filename,"download")" &gt;
     &lt;img src="$userdoc.getAttachmentURL($attach.filename,"download")" width="${width}" /&gt;&lt;/a&gt;
     &lt;br/&gt;&lt;br/&gt;&lt;a class="curriki-link" href="$userdoc.getAttachmentURL("${attach.filename}", "delattachment", "xredirect=${xeditredirect}")" onclick="return confirm('$msg.get("profile.removePhoto.confirmation")');" title="$msg.get("profile.removeYourPhoto")"&gt;$msg.get("profile.removePhoto")&lt;/a&gt;
     &lt;br/&gt;&lt;br/&gt;
   #end
#end
   &lt;/div&gt;
  &lt;/td&gt;
  &lt;td width="100%"&gt;
   &lt;table border="0" cellspacing="2" cellpadding="2"&gt;
    &lt;tr&gt;
     &lt;td&gt; *${msg.get("profile.field.firstName")}* 
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("first_name", "edit", $userobj) &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.lastName")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("last_name", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.memberType")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("member_type", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.affiliation")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("affiliation", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/tr&gt;
     &lt;td&gt; *$msg.get("profile.field.city")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("city", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.state")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("state", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.country")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("country", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/tr&gt;
     &lt;td&gt; *$msg.get("profile.field.showContact")*
     $userdoc.display("show_contact", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/tr&gt;
     &lt;td&gt; *$msg.get("profile.field.email")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("email", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.opt_out")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("opt_out", "edit", $userobj) $msg.get("profile.field.opt_out.checkbox_text")&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.password")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("password", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.passwordConfirm")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     {pre}&lt;input size='30' id='XWiki.XWikiUsers_0_password_repeat' value='$userdoc.display("password", "view", $userobj)' name='XWiki.XWikiUsers_0_password_repeat' type='password'/&gt;{/pre}&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/tr&gt;
     &lt;td&gt; *$msg.get("profile.field.topics")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("topics", "edit", $userobj)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
     &lt;td&gt; *$msg.get("profile.field.bio")*
     &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
     $userdoc.display("comment", "edit", $userobj) &lt;/td&gt;
    &lt;/tr&gt;
   &lt;/table&gt;
  &lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;div class="button-right"&gt;
&lt;input class="button button-grey" type="submit" name="formactioncancel" value="$msg.get("cancel")" onclick="document.forms.inline.action='$userdoc.getURL("cancel", "xredirect=$xredirect")'; document.forms.inline.submit(); return false;"/&gt;
## &lt;input class="button button-orange" type="submit" name="formactionpreview" value="$msg.get("preview")" onclick="document.forms.inline.action='$userdoc.getURL("preview")'; if(document.forms.inline.onsubmit() == false) return false; document.forms.inline.submit(); return false;"/&gt;
## &lt;input class="button button-orange" type="submit" name="formactionsac" value="$msg.get("saveandcontinue")" onclick="document.forms.inline.action='$userdoc.getURL("saveandcontinue", "xredirect=$xredirect")'; if (document.forms.inline.onsubmit()==false) return false; document.forms.inline.submit(); return false;"/&gt;
&lt;input class="button button-orange" type="submit" name="formactionsave" value="$msg.get("mycurriki.editprofile.saveButton")" onclick="document.forms.inline.action='$userdoc.getURL("save", "xredirect=$xredirect")'; if(document.forms.inline.onsubmit() == false) return false; document.forms.inline.submit(); return false;"/&gt;
&lt;/div&gt;
{pre}
&lt;script type="text/javascript"&gt;
function checkInlineForm() {
  var isValid = true;
   if(document.forms.inline['XWiki.XWikiUsers_0_password'].value.indexOf(" ") &gt;= 0){
     alert("$msg.get("profile.field.password.nospaces")");
     isValid = false;
   }

   if (document.forms.inline['XWiki.XWikiUsers_0_password'].value.length &lt; 5) {
     alert("$msg.get("profile.field.password.tooShort")");
     isValid = false;
   }

   if (document.forms.inline['XWiki.XWikiUsers_0_first_name'].value.length == 0) {
     alert("$msg.get("profile.field.firstName.mandatory")");
     isValid = false;
   }

   if (document.forms.inline['XWiki.XWikiUsers_0_last_name'].value.length == 0) {
     alert("$msg.get("profile.field.lastName.mandatory")");
     isValid = false;
   }

   var emailStr = document.forms.inline['XWiki.XWikiUsers_0_email'].value;
   if (emailStr.length &lt;= 1) {
     alert("$msg.get("profile.field.email.mandatory")");
     isValid = false;
   } else {
     var atIndex = emailStr.indexOf("@");
     if ((atIndex &lt; 1) || (emailStr.lastIndexOf(".") &lt;= (atIndex+1)) || (emailStr.length &lt;= (emailStr.lastIndexOf(".") + 1)) || (emailStr.lastIndexOf("@") != atIndex)) {
       alert("$msg.get("profile.field.email.invalid")");
       isValid = false;
     }
   }

   if (document.forms.inline['XWiki.XWikiUsers_0_password_repeat'].value != document.forms.inline['XWiki.XWikiUsers_0_password'].value){
       alert("$msg.get("profile.field.password.mustMatch")");
       isValid = false;
  }
  if (isValid) {
    // checkEmail();
    return true;
  }
  return false;
}
 function checkEmail(){
    var email = $F("XWiki.XWikiUsers_0_email");
    var account = "XWiki.${shortname}";
    var url= "$xwiki.getURL("XWiki.CheckAccountCreation").replaceAll("http","https")";
    var pars = 'xpage=plain&amp;email=' + email + '&amp;account=' + account;
    var myAjax = new Ajax.Request( url, { method: 'get', parameters: pars, onComplete: checkEmailResponse });
    return false;
  }

  function checkEmailResponse(originalRequest){
     var text = originalRequest.responseText;
     var res = eval('[' + text + '][0]');
     if(!res.email){
       alert("$msg.get("joincurriki.email.alreadyUsed")");
       return false;
     }  
     document.forms.inline.onSubmit = "";
     document.forms.inline.submit();
  }
  document.forms.inline.onsubmit=checkInlineForm;

&lt;/script&gt;
{/pre}
#if("$!footerJScript" == "")
#set($footerJScript = "")
#end
#set($footerJScript = $footerJScript + '&lt;script&gt;$$("a").invoke("observe", "click", function(event){ if (!confirm("'+$msg.get('mycurriki.editprofile.confirmLeave')+'")){ event.preventDefault();}; });&lt;/script&gt;')
#end ## content macro
## END OF MACROS
## END OF SETTINGS
## Display of page
#mycurrikipage("profile")</content>
</xwikidoc>
