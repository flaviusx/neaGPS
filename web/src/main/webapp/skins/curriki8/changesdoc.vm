<div id="changes-title">
<h1>$msg.get("changes.changes") $doc.name $msg.get("changes.in") $msg.get("changes.space") $doc.web</h1>
</div>
<div id="changes-info">
<table class="changes-table">
<tr>
<th>$msg.get("changes.from")</th>
<th>$msg.get("changes.to")</th>
</tr>
<tr>
<th colspan="2">$msg.get("changes.comment"): #if($newdoc.comment=="") $msg.get("changes.nocomment") #else $newdoc.comment #end </th>
</tr>
<tr>
<td>
$msg.get("changes.version") $request.rev1
<br />
#if($origdoc)
$msg.get("changes.editedby") $xwiki.renderText($xwiki.getLocalUserName($newdoc.author),$doc)
<br />
$msg.get("changes.on") $xwiki.formatDate($origdoc.date)
#end
</td>
<td>
$msg.get("changes.version") $request.rev2
<br />
#if($newdoc)
$msg.get("changes.editedby") $xwiki.renderText($xwiki.getLocalUserName($newdoc.author),$doc)
<br />
$msg.get("changes.on") $xwiki.formatDate($newdoc.date)
#end
</td>
</tr>
</table>
</div>

<div id="changes-metadata">
<table class="changes-table">
<tr>
<th colspan="3">$msg.get("changes.metadatachanges")</th>
</tr>
<tr>
<th>$msg.get("changes.property")</th><th>$msg.get("changes.version") $request.rev1</th><th>$msg.get("changes.version") $request.rev2</th>
</tr>
#set($hasmetadatachanges = 0)
#foreach($item in $doc.getMetaDataDiff($origdoc, $newdoc))
#set($hasmetadatachanges = 1)
<tr>
#if($item.field=="author")
<td>$msg.get("changes.author")</td><td>$xwiki.getLocalUserName($item.getPrevvalue())</td><td>$xwiki.getLocalUserName($item.getNewvalue())</td>
#else
<td>$item.getField()</td><td>$item.getPrevValue().toString()</td><td>$item.getNewValue().toString(), false)</td>
#end
</tr>
#end
#if($hasmetadatachanges==0)
<tr><td colspan="3">$msg.get("changes.nometadatachanges")</td></tr>
#end
</table>
</div>

#set($ok = $origdoc.use("XWiki.TextAssetClass"))
#set($origcontent = $!origdoc.getValue("text").trim())
#if(!$origcontent)
#set($text1 = "")
#else
#set($text1 = $origcontent)
#end
#set($ok = $newdoc.use("XWiki.TextAssetClass"))
#set($newcontent = $!newdoc.getValue("text").trim())
#if(!$newcontent)
#set($text2 = "")
#else
#set($text2 = $newcontent)
#end
<div id="changes-content">
<table class="changes-table">
<tr>
<th>$msg.get("changes.contentchanges")</th>
</tr>
<tr>
<td>
#if($text1.equals($text2))
$msg.get("changes.nocontentchanges")
#else
$xwiki.diff.getDifferencesAsHTML($text1, $text2 ,false)
#end
</td>
</tr>
</table>
</div>

<div id="changes-attachment">
<table class="changes-table">
<tr>
<th colspan="3">$msg.get("changes.attachmentchanges")</th>
</tr>
<tr>
<th>$msg.get("changes.filename")</th><th>$msg.get("changes.action")</th>
</tr>
#set($hasattachmentchanges = 0)
#foreach($attachChange in $doc.getAttachmentDiff($origdoc, $newdoc))
#set($hasattachmentchanges = 1)
<tr>
<td>
$attachChange.fileName
</td>
<td>
#if(!$attachChange.origVersion)
<a href="$newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.newVersion)">$msg.get("changes.attachmentadded")</a>
#elseif(!$attachChange.newVersion)
$msg.get("changes.attachmentdeleted")
#else
$msg.get("changes.attachmentupdatedfromversion") <a href="$newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.origVersion)">$attachChange.origVersion</a>
$msg.get("changes.toversion") <a href="$newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.newVersion)">$attachChange.newVersion</a>
#end
</td>
</tr>
#end
#if($hasattachmentchanges==0)
<tr><td colspan="3">$msg.get("changes.noattachmentchanges")</td></tr>
#end
</table>

<div id="changes-comments">
<table class="changes-table">
<tr>
<th colspan="3">$msg.get("changes.commentchanges")</th>
</tr>
#set($commentchanges = 0)
#foreach($objdiffs in $doc.getObjectDiff($origdoc, $newdoc))
#set($commentchangetitledone = 0)
#foreach($objdiff in $objdiffs)
#if($objdiff.getClassName().equals("XWiki.XWikiComments"))
#if($commentchangetitledone==0)
#set($commentchanges = 1 + $commentchanges)
#set($commentchangetitledone = 1)
<tr>
<td colspan="3">$msg.get("changes.commentchange") $commentchanges</th>
</tr>
<tr>
<td>$msg.get("changes.comment.property")</td>
<td>$msg.get("changes.comment.previousvalue")</td>
<td>$msg.get("changes.comment.newvalue")</td>
</tr>
#end
#set($propname = $objdiff.getPropName())
<tr>
<td>$msg.get("changes.comment.${propname}")</td>
<td>
#if($propname=="author")
#set($author = $objdiff.getPrevValue().toString())
#if($author!="")
$xwiki.renderText($xwiki.getLocalUserName($author),$doc)
#end
#else
$objdiff.getPrevValue().toString()
#end
</td>
<td>
#if($propname=="author")
#set($author = $objdiff.getNewValue().toString())
#if($author!="")
$xwiki.renderText($xwiki.getLocalUserName($author),$doc)
#end
#else
$objdiff.getNewValue().toString()
#end
</td>
</tr>
#end
#end
#end
#if($commentchanges==0)
<tr><td colspan="3">$msg.get("changes.nocommentchanges")</td></tr>
#end
</table>
</div>
