#* @vtlvariable name="doc" type="com.xpn.xwiki.api.Document" *#
## @vtlvariable name="asset" type="org.curriki.xwiki.plugin.asset.Asset"
## @vtlvariable name="document" type="com.xpn.xwiki.api.Document"
#* @vtlvariable name="xwiki" type="com.xpn.xwiki.api.XWiki" *# ##
#* @vtlvariable name="util" type="com.xpn.xwiki.api.Util" *# ##
#* @vtlvariable name="request" type="javax.servlet.http.HttpServletRequest" *# ##
#* @vtlvariable name="context" type="com.xpn.xwiki.api.Context" *# ##
#* @vtlvariable name="msg" type="com.xpn.xwiki.web.XWikiMessageTool" *# ##
#* @vtlvariable name="escapetool" type="org.apache.velocity.tools.generic.EscapeTool" *# ##
#**
  * Displays the Curriki Header
  * @author Curriki dev team
  *#
<!-- header -->
<div id="header"> ##{
<!-- logo -->
## TODO: Add translation for title and alt
#set($altinfo = $msg.get("header.altinfo"))
#set($logourl = $xwiki.getSkinFile("images/curriki-logo.gif"))
<div id="header-logo"> ##{
  <a href="$xwiki.getURL("Main.WebHome", "view")" title="$altinfo">
    <img src="$logourl" title="$altinfo" alt="$altinfo" />
  </a>
</div> ##}

<!-- member area -->
<div id="header-member"> ##{
#if($isguest) <!-- request.pathInfo is $request.pathInfo --> #if(!$request.pathInfo.startsWith('/login/'))
##{
	#if ($request.xredirect) ##{
		#set($logredir = $request.xredirect)
	#elseif($doc.web == "Registration") ##}{
		#set($logredir = $xwiki.getURL("MyCurriki.Profile"))
	#elseif($doc.fullName == "Main.WebHome") ##}{
		#set($logredir = $xwiki.getURL("MyCurriki.Profile"))
	#elseif($doc.fullName == "Main.JoinCurriki") ##}{
		#set($logredir = $xwiki.getURL("MyCurriki.Profile"))
	#elseif($logredir.contains("/login")) ##}{
		#set($logredir = "")
	#end ##}
	#if("$!logredir"!="") ##{
		#set($logredir = "xredirect=$logredir")
	#elseif($request.srid) ##}{
		#set($logredir = "srid=$request.srid")
	#end ##}
    #set($escapedURL=$escapetool.url($request.getRequestURI()))##
    #set($targetURL="/xwiki/bin/login/Registration/LoginOrRegister?xpage=popup&xredirect=$escapedURL")
    #set($anchorAtts="href='$targetURL' onclick='Curriki.ui.login.displayLoginDialog(&quot;$escapetool.xml($targetURL)&quot;); return false;'")
    <a $anchorAtts>$msg.get("join.login.title")</a><br/>

    <p>#foreach($provider in ["Facebook","Google"])
      <!-- provider is "$provider" of class $provider.getClass(), socialLoginConfigurationDocument = $socialLoginConfigurationDocument -->
        #set($xredirect=$escapetool.url("http://${xwiki.xWiki.Param('curriki.system.hostname', 'broken-url2')}${request.getRequestURI()}"))##
      #set($link = "/xwiki/bin/view/Registration/SocialLogin?provider=${provider.toLowerCase()}&xredirect=$xredirect#if($framed)&xpage=popup#end")
      <a target="_top" href="${link}" title="$msg.get("join.login.social.login-with-${provider}.tooltip")" width="32" ##
              onclick="Curriki.ui.login.popupPopupAndIdentityAuthorization('${provider}','${link}'); return false;">##
      <img src="/xwiki/skins/curriki8/registration/${provider.toLowerCase()}-logo.png" width="24"
           title="$escapetool.xml($msg.get("join.login.social.login-with-${provider}.tooltip"))" /></a>
      #end
    #end</p>
#else ## }{ ## is logged in
	## crtUserDoc is set in fudocs.vm
	#set($fname = $crtUserDoc.display("first_name","view"))
	<span class="welcome"><a href='$crtUserDoc.getURL()'>$msg.get("header.welcome", ["$fname"])</a></span>
	#if($hasGlobalAdmin)
	<a href="$xwiki.getURL("Admin.WebHome","view")">$msg.get("header.admin")</a> #sep()
	#end
    #if("MyCurriki"=="$doc.space")
     #set($logredir = "/xwiki/bin/view/MyCurriki/${doc.name}?user=${crtUserDoc.fullName}")
    #elseif($xwiki.hasAccessLevel("view","XWiki.XWikiGuest","$doc.fullName"))
        #set($logredir = $request.getRequestURI())
    #else
        #set($logredir = $xwiki.getURL("Main.WebHome"))
    #end
	#set($logouturl = $xwiki.getURL("XWiki.XWikiLogout","logout", "xredirect=$logredir"))
	<a href="$logouturl" class="logout" onclick="window.location.replace('$logouturl'); return false;">$msg.get("header.logout")</a>
#end ##}
#if($request.session.getAttribute("header.message")=="logout-ok")##
    $request.session.removeAttribute("header.message")##
    #set($provider=$request.session.getAttribute("org.brickred.socialauth.AuthProvider.hint"))##
    <!-- provider: "$provider" -->
    #if($request.session.getAttribute("org.brickred.socialauth.AuthProvider.hint"))##
        $request.session.removeAttribute("org.brickred.socialauth.AuthProvider.hint")##
        $request.session.removeAttribute("org.brickred.socialauth.AuthProvider")##
        $request.session.removeAttribute("org.brickred.socialauth.Profile ")##
        #if($provider.equalsIgnoreCase("facebook"))#set($logoutUrl="http://www.facebook.com/logout.php")##
        #elseif($provider.equalsIgnoreCase("google"))#set($logoutUrl="http://www.google.com/accounts/Logout?continue=http://www.google.com/")##
        #end##
    #end##
    <p align="right" style="font-size:smaller; margin-top: -1em">$msg.get("logout.ok-you-left")##
    #if($logoutUrl)##
            <br/><a href="$logoutUrl">$msg.get("logout.offer-logout.${provider}")</a>##
    #end##
    </p>
#end
##
</div> ##} ##header-member
<!-- end of member area -->

<!-- advanced search -->
#set($defaultsearchtext = $msg.get("header.defaultsearchtext"))
#set($brsqry = $request.brsqry)
#if(!$brsqry || $brsqry == "")
	#set($brsqry = $defaultsearchtext)
#end
<div id="header-search"> ##{
	<form id="searchform" name="searchform" class="search-box" action="$xwiki.getURL("Search.WebHome")" onsubmit="CurrikiApp.searchbtnGo(); return false;"> ##{
		<input type="hidden" class="hidden" name="area" value=""/>
		<input type="text" id="curriki-searchbox" name="brsqry" class="input" value="$!brsqry" Curriki:defTxt="$defaultsearchtext" />
		<a href="" id="searchbtn" onclick="CurrikiApp.searchbtnGo(); return false;">$msg.get("header.search_go")</a>
	</form>
	<p>
		<a href="$xwiki.getURL("Search.WebHome")" onclick="this.href='/xwiki/bin/view/Search/#o%3Aa%3Do%253Aresource%253Do%25253Aa%25253Db%2525253A1%5Ef%3Do%253Aresource%253Do%25253Aterms%25253Ds%2525253A'+escape(escape(escape(escape($('curriki-searchbox').value.replace(/^$defaultsearchtext/, '').replace(/^\.\.\./, ''))))); return true;">$msg.get("header.advanced_search")</a> |
		<a href="$xwiki.getURL("Main.Browse")">$msg.get("header.browse_subjects")</a>
	</p>
</div> ##} ##member-search
<!-- end of advanced search -->  

</div> ##} ##header
<!-- end of header -->
