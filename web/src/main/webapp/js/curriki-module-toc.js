(function(){Ext.ns("Curriki.module.toc");Ext.ns("Curriki.data.toc");var B=Curriki.module.toc;var A=Curriki.data.toc;B.init=function(){B.vars={};B.getQueryParam=function(D){D=D.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var C="[\\?&]"+D+"=([^&#]*)";var F=new RegExp(C);var E=F.exec(window.location.href);if(E==null){return""}else{return E[1]}};Curriki.ui.treeLoader.TOC=function(C){Curriki.ui.treeLoader.TOC.superclass.constructor.call(this)};Ext.extend(Curriki.ui.treeLoader.TOC,Curriki.ui.treeLoader.Base,{setChildHref:true,createNode:function(H){console.log("TOC createNode: ",H);if("string"!==Ext.type(H.qtip)&&"string"===Ext.type(H.description)&&"array"===Ext.type(H.fwItems)&&"array"===Ext.type(H.levels)){var G=H.description||"";G=Ext.util.Format.ellipsis(G,256);G=Ext.util.Format.htmlEncode(G);var J=H.fwItems||[];var E="";var D=Curriki.data.fw_item.fwMap;if(J[0]==="FW_masterFramework.WebHome"){J.shift()}if("undefined"!==typeof J&&"undefined"!==typeof J[0]){var L="";var C=J[0];var F=D["FW_masterFramework.WebHome"].find(function(N){return(D[N.id].find(function(O){return O.id==C}))});if(!Ext.type(F)){L=_("CurrikiCode.AssetClass_fw_items_"+C)}else{F=F.id;L=_("CurrikiCode.AssetClass_fw_items_"+F)+" > "+_("CurrikiCode.AssetClass_fw_items_"+C)}E+=Ext.util.Format.htmlEncode(L)+"<br />";if("undefined"!==typeof J[1]){var L="";var C=J[1];var F=D["FW_masterFramework.WebHome"].find(function(N){return(D[N.id].find(function(O){return O.id==C}))});if(!Ext.type(F)){L=_("CurrikiCode.AssetClass_fw_items_"+C)}else{F=F.id;L=_("CurrikiCode.AssetClass_fw_items_"+F)+" > "+_("CurrikiCode.AssetClass_fw_items_"+C)}E+=Ext.util.Format.htmlEncode(L)+"<br />";if("undefined"!==typeof J[2]){E+="...<br />"}}}var M=H.levels||[];var I="";if("undefined"!==typeof M&&"undefined"!==typeof M[0]){I+=Ext.util.Format.htmlEncode(_("CurrikiCode.AssetClass_educational_level_"+M[0]))+"<br />";if("undefined"!==typeof M[1]){I+=Ext.util.Format.htmlEncode(_("CurrikiCode.AssetClass_educational_level_"+M[1]))+"<br />";if("undefined"!==typeof M[2]){I+="...<br />"}}}H.qtip=String.format("{1}<br />{0}<br /><br />{3}<br />{2}<br />{5}<br />{4}",G,_("mycurriki.favorites.mouseover.description"),E,_("mycurriki.favorites.mouseover.subject"),I,_("mycurriki.favorites.mouseover.level"))}if("string"===typeof H.id){var K=Curriki.ui.treeLoader.TOC.superclass.createNode.call(this,H);console.log("TOC createNode: parent",K);return K}var K=Curriki.ui.treeLoader.TOC.superclass.createNode.call(this,H);console.log("TOC createNode: call super",K);return K}});B.displayMainPanel=function(C){B.vars.panel=new Ext.tree.TreePanel({id:"TOCPanel",applyTo:"resource-toc",title:_("curriki.toc.title"),autoHeight:true,cls:"resource resource-toc",border:false,useArrows:true,lines:true,containerScroll:false,enableDD:false,loader:new Curriki.ui.treeLoader.TOC(),root:C,listeners:{beforeclick:{fn:function(D,F){var E=D.getPath().replace(/\//g,";");var G=Curriki.module.toc.getQueryParam("viewer");if(G!==""){G="&viewer="+G}window.location.href="/xwiki/bin/view/"+D.id.replace(".","/")+"?bc="+E+G;return false}},load:{fn:function(){if(typeof B.vars.foundSelect==="undefined"){var D=C.findChild("id",A.selected);if(!Ext.isEmpty(D)){D.select();B.vars.foundSelect=true}}}}}})};B.buildTree=function(){var C=A.tocData;C.cls=C.cls+" toc-top";C.listeners={beforecollapse:{fn:function(){return false}}};C=new Ext.tree.AsyncTreeNode(C);return C};B.display=function(){B.displayMainPanel(B.buildTree())};B.initialized=true;return true};B.start=function(){Ext.onReady(function(){if(B.init()){B.display()}})};Ext.onReady(function(){Curriki.module.toc.start()})})();