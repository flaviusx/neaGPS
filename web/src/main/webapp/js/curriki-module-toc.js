(function(){Ext.ns("Curriki.module.toc");Ext.ns("Curriki.data.toc");var B=Curriki.module.toc;var A=Curriki.data.toc;B.init=function(){B.vars={};B.getQueryParam=function(D){D=D.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var C="[\\?&]"+D+"=([^&#]*)";var F=new RegExp(C);var E=F.exec(window.location.href);if(E==null){return""}else{return E[1]}};Curriki.ui.treeLoader.TOC=function(C){Curriki.ui.treeLoader.TOC.superclass.constructor.call(this)};Ext.extend(Curriki.ui.treeLoader.TOC,Curriki.ui.treeLoader.Base,{setChildHref:true,createNode:function(G){console.log("TOC createNode: ",G);if("string"!==Ext.type(G.qtip)&&"string"===Ext.type(G.description)&&"array"===Ext.type(G.fwItems)&&"array"===Ext.type(G.levels)){var F=G.description||"";F=Ext.util.Format.ellipsis(F,256);F=Ext.util.Format.htmlEncode(F);var I=G.fwItems||[];var D="";if("undefined"!==typeof I&&"undefined"!==typeof I[0]){var K="";var C=I[0];var E=f.store.subsubject.getById(C).get("parentItem");if(E===C){K=f.store.subject.getById(E).get("subject")}else{K=f.store.subject.getById(E).get("subject")+" > "+f.store.subsubject.getById(C).get("subject")}D+=Ext.util.Format.htmlEncode(K)+"<br />";if("undefined"!==typeof I[1]){var K="";var C=I[1];var E=f.store.subsubject.getById(C).get("parentItem");if(E===C){K=f.store.subject.getById(E).get("subject")}else{K=f.store.subject.getById(E).get("subject")+" > "+f.store.subsubject.getById(C).get("subject")}D+=Ext.util.Format.htmlEncode(K)+"<br />";if("undefined"!==typeof I[2]){D+="...<br />"}}}var L=G.levels||[];var H="";if("undefined"!==typeof L&&"undefined"!==typeof L[0]){H+=Ext.util.Format.htmlEncode(_("CurrikiCode.AssetClass_educational_level_"+L[0]))+"<br />";if("undefined"!==typeof L[1]){H+=Ext.util.Format.htmlEncode(_("CurrikiCode.AssetClass_educational_level_"+L[1]))+"<br />";if("undefined"!==typeof L[2]){H+="...<br />"}}}G.qtip=String.format("{1}<br />{0}<br /><br />{3}<br />{2}<br />{5}<br />{4}",F,_("mycurriki.favorites.mouseover.description"),D,_("mycurriki.favorites.mouseover.subject"),H,_("mycurriki.favorites.mouseover.level"))}if("string"===typeof G.id){var J=Curriki.ui.treeLoader.TOC.superclass.createNode.call(this,G);console.log("TOC createNode: parent",J);return J}var J=Curriki.ui.treeLoader.TOC.superclass.createNode.call(this,G);console.log("TOC createNode: call super",J);return J}});B.displayMainPanel=function(C){B.vars.panel=new Ext.tree.TreePanel({id:"TOCPanel",applyTo:"resource-toc",title:_("curriki.toc.title"),autoHeight:true,cls:"resource resource-toc",border:false,useArrows:true,lines:true,containerScroll:false,enableDD:false,loader:new Curriki.ui.treeLoader.TOC(),root:C,listeners:{beforeclick:{fn:function(D,F){var E=D.getPath().replace(/\//g,";");var G=Curriki.module.toc.getQueryParam("viewer");if(G!==""){G="&viewer="+G}window.location.href="/xwiki/bin/view/"+D.id.replace(".","/")+"?bc="+E+G;return false}},load:{fn:function(){if(typeof B.vars.foundSelect==="undefined"){var D=C.findChild("id",A.selected);if(!Ext.isEmpty(D)){D.select();B.vars.foundSelect=true}}}}}})};B.buildTree=function(){var C=A.tocData;C.cls=C.cls+" toc-top";C.listeners={beforecollapse:{fn:function(){return false}}};C=new Ext.tree.AsyncTreeNode(C);return C};B.display=function(){B.displayMainPanel(B.buildTree())};B.initialized=true;return true};B.start=function(){Ext.onReady(function(){if(B.init()){B.display()}})};Ext.onReady(function(){Curriki.module.toc.start()})})();